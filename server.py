import os
import json
import pandas as pd
import google.generativeai as genai
import firebase_admin
from firebase_admin import credentials, db
from datetime import datetime, timedelta  # ‡πÄ‡∏û‡∏¥‡πà‡∏° timedelta ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏ß‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢
from flask import Flask, request, jsonify
from flask_cors import CORS
import traceback

# =====================================================
# 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö & ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å Environment
# =====================================================
app = Flask(__name__)
CORS(app)

print("üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö AI Data Scientist Server (Secure & Timezone Fixed)...")

# üîê 1. ‡∏î‡∏∂‡∏á Key ‡∏à‡∏≤‡∏Å Environment (Render) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY")
FIREBASE_CONFIG_JSON = os.environ.get("FIREBASE_SERVICE_ACCOUNT")

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ Key ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Debug ‡πÑ‡∏î‡πâ)
if not GEMINI_API_KEY:
    print("‚ö†Ô∏è Warning: ‡πÑ‡∏°‡πà‡∏û‡∏ö GEMINI_API_KEY ‡πÉ‡∏ô Environment")

if not FIREBASE_CONFIG_JSON:
    print("‚ö†Ô∏è Warning: ‡πÑ‡∏°‡πà‡∏û‡∏ö FIREBASE_SERVICE_ACCOUNT ‡πÉ‡∏ô Environment")

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Gemini
if GEMINI_API_KEY:
    genai.configure(api_key=GEMINI_API_KEY)

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ Environment ‡∏ö‡∏ô Cloud)
try:
    if not firebase_admin._apps:
        cred = None
        if FIREBASE_CONFIG_JSON:
            # ‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏±‡∏ô‡∏ö‡∏ô Cloud (Render)
            cred = credentials.Certificate(json.loads(FIREBASE_CONFIG_JSON))
            print("‚úÖ ‡πÇ‡∏´‡∏•‡∏î Firebase ‡∏à‡∏≤‡∏Å Environment ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
        elif os.path.exists("serviceAccountKey.json"):
            # ‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (Local Fallback)
            cred = credentials.Certificate("serviceAccountKey.json")
            print("‚úÖ ‡πÇ‡∏´‡∏•‡∏î Firebase ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå JSON ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
            
        if cred:
            firebase_admin.initialize_app(cred, {
                'databaseURL': 'https://win-assistant-462002-default-rtdb.asia-southeast1.firebasedatabase.app'
            })
            print("‚úÖ Firebase Connected!")
except Exception as e:
    print(f"‚ùå Firebase Error: {e}")

# ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Model
valid_model_name = "models/gemini-1.5-flash"

# =====================================================
# 2. ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Pandas) + ‡πÅ‡∏Å‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢
# =====================================================
df = pd.DataFrame() 

def refresh_data():
    global df
    print("üì• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase...")
    try:
        ref = db.reference('History')
        data = ref.get()
        if not data: return "Database Empty"

        records = []
        for key, val in data.items():
            if isinstance(val, dict) and 'ts' in val:
                # üïí 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤: ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô UTC ‡πÅ‡∏ó‡πâ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏ß‡∏Å 7 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢)
                dt = datetime.utcfromtimestamp(val['ts'] / 1000) + timedelta(hours=7)
                
                wind_p = float(val.get('wind', {}).get('p', 0))
                batt_p = float(val.get('batt', {}).get('p', 0))
                wind_v = float(val.get('wind', {}).get('v', 0))
                batt_v = float(val.get('batt', {}).get('v', 0))
                
                records.append({
                    "datetime": dt,
                    "date": dt.strftime("%Y-%m-%d"),
                    "hour": dt.hour,
                    "minute": dt.minute,
                    "wind_p": wind_p,
                    "batt_p": batt_p,
                    "wind_wh": wind_p / 60,
                    "batt_wh": batt_p / 60,
                    "wind_v": wind_v,
                    "batt_v": batt_v
                })
        
        df = pd.DataFrame(records)
        df['datetime'] = pd.to_datetime(df['datetime'])
        print(f"‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå: {len(df)} ‡πÅ‡∏ñ‡∏ß (‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢ UTC+7)")
        return f"‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {len(df)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"
    except Exception as e:
        return f"Error: {e}"

# ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ñ‡πâ‡∏≤ Firebase ‡∏û‡∏£‡πâ‡∏≠‡∏°
if firebase_admin._apps:
    refresh_data()

# =====================================================
# 3. AI Tools & Functions
# =====================================================

def execute_python_analysis(code_string):
    global df
    print(f"\n[AI Thinking] üß† ‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...")
    if any(forbidden in code_string for forbidden in ["import os", "import sys", "open(", "eval("]):
        return "Security Alert: ‡πÇ‡∏Ñ‡πâ‡∏î‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á"

    local_vars = {"df": df, "pd": pd, "result": None}
    try:
        exec(code_string, {}, local_vars)
        return str(local_vars.get('result', "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ 'result'"))
    except Exception as e:
        return f"Code Error: {e}"

def get_realtime_string():
    try:
        ref = db.reference('History')
        snapshot = ref.order_by_key().limit_to_last(1).get()
        if not snapshot: return "No Data"
        val = list(snapshot.values())[0]
        w_v, b_v = val.get('wind', {}).get('v', 0), val.get('batt', {}).get('v', 0)
        pct = max(0, min(100, ((b_v - 3.2) / (4.2 - 3.2)) * 100))
        return f"Wind: {w_v}V, Batt: {b_v}V ({int(pct)}%)"
    except: return "Error"

# =====================================================
# 4. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏°‡∏≠‡∏á AI
# =====================================================
tools_list = [execute_python_analysis, refresh_data]
chat = None

if GEMINI_API_KEY:
    try:
        model = genai.GenerativeModel(
            model_name=valid_model_name,
            tools=tools_list,
            system_instruction="""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ Data Scientist AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏•‡∏° 
            - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô df ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢ (UTC+7) ‡πÅ‡∏•‡πâ‡∏ß
            - ‡πÉ‡∏ä‡πâ execute_python_analysis ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å df (Pandas)
            - ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ result ‡πÄ‡∏™‡∏°‡∏≠
            - ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à"""
        )
        chat = model.start_chat(enable_automatic_function_calling=True)
    except Exception as e:
        print(f"‚ùå Model Init Error: {e}")

# =====================================================
# 5. API Routes
# =====================================================

@app.route('/')
def home():
    return "Wind AI Server is Running (GitHub Ready)!"

@app.route('/ask', methods=['POST'])
def ask_ai():
    global chat
    try:
        if not chat:
             # ‡∏•‡∏≠‡∏á Re-connect ‡∏ñ‡πâ‡∏≤‡∏´‡∏•‡∏∏‡∏î
             if GEMINI_API_KEY:
                 model = genai.GenerativeModel(model_name=valid_model_name, tools=tools_list)
                 chat = model.start_chat(enable_automatic_function_calling=True)
             else:
                 return jsonify({"answer": "Error: AI not initialized (Check API Key)"})

        user_input = request.json.get('question')
        live_status = get_realtime_string()
        
        # üïí 3. ‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡πâ AI (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ/‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô')
        now_thai = (datetime.utcnow() + timedelta(hours=7)).strftime("%Y-%m-%d %H:%M:%S")
        
        prompt = f"[Current Thai Time: {now_thai}] [Status: {live_status}] Question: {user_input}"
        
        response = chat.send_message(prompt)
        return jsonify({"answer": response.text})
    except Exception as e:
        traceback.print_exc()
        return jsonify({"answer": f"Error: {str(e)}"})

if __name__ == '__main__':
    # ‡∏£‡∏±‡∏ö Port ‡∏à‡∏≤‡∏Å Environment ‡∏Ç‡∏≠‡∏á Render
    port = int(os.environ.get("PORT", 5000))
    app.run(host='0.0.0.0', port=port)
